<!DOCTYPE html>
<html>
<head>
    <title>Signup</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body{
            background: linear-gradient(135deg,#b097eb3f,#9fc4e688);
            height:100vh;
            display:flex;
            align-items:center;
            justify-content:center;
        }

        .signup-card{
            width:400px;
            border-radius:15px;
            box-shadow:0 8px 25px rgba(0,0,0,0.1);
        }
        .toast-box{
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
}

.toast-msg{
    background: #333;
    color: #fff;
    padding: 12px 18px;
    margin-bottom: 10px;
    border-radius: 8px;
    min-width: 220px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    animation: fadeIn 0.4s ease;
}

.toast-success{ background: #28a745; }
.toast-error{ background: #dc3545; }
.toast-info{ background: #17a2b8; }

@keyframes fadeIn{
    from {opacity:0; transform:translateX(50px);}
    to {opacity:1; transform:translateX(0);}
}

    </style>
</head>

<body>

<div class="card signup-card p-4">
    <!-- Toast Container -->
<div id="toastBox" class="toast-box"></div>
    <h3 class="text-center mb-3">Create Account</h3>

    <!-- <form method="POST" action="{% url 'signup' %}"> -->
    
<!-- <form id="signupForm" onsubmit="event.preventDefault(); signupUser();"> -->
<form id="signupForm" method="POST">

{% csrf_token %}

<!-- FIRST NAME -->
<div class="mb-3">
<label>First Name <span class="text-danger">*</span></label>
<input id="first_name" name="first_name" class="form-control">
<div class="invalid-feedback" id="first_name_error"></div>
</div>

<!-- LAST NAME -->
<div class="mb-3">
<label>Last Name</label>
<input id="last_name" name="last_name" class="form-control">
<div class="invalid-feedback" id="last_name_error"></div>
</div>

<!-- EMAIL -->
<div class="mb-3">
<label>Email <span class="text-danger">*</span></label>
<input id="email" name="email" type="email" class="form-control">
<div class="invalid-feedback" id="email_error"></div>
</div>

<!-- USERNAME -->
<div class="mb-3">
<label>Username <span class="text-danger">*</span></label>
<input id="username" name="username" class="form-control">
<div class="invalid-feedback" id="username_error"></div>
</div>

<!-- PASSWORD -->
<div class="mb-3">
<label>Password <span class="text-danger">*</span></label>
<input id="password" name="password" type="password" class="form-control">
<div class="invalid-feedback" id="password_error"></div>
</div>

<!-- CONFIRM -->
<div class="mb-3">
<label>Confirm Password <span class="text-danger">*</span></label>
<input id="confirm_password" name="confirm_password" type="password" class="form-control">
<div class="invalid-feedback" id="confirm_password_error"></div>
</div>

<button type="submit" id="signupBtn" class="btn btn-primary w-100">
Signup
</button>

</form>


    <p class="text-center mt-3">
        Already have an account?
        <a href="/login">Login</a>
    </p>

    <div id="msg"></div>

</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdn.jsdelivr.net/jquery.validation/1.19.5/jquery.validate.min.js"></script>

<script>

function signupUser() {

    clearErrors();

    const btn = document.getElementById("signupBtn");

    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Signing up...`;
    btn.disabled = true;

    fetch("/signup", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({
            first_name: document.getElementById("first_name").value,
            last_name: document.getElementById("last_name").value,
            email: document.getElementById("email").value,
            username: document.getElementById("username").value,
            password: document.getElementById("password").value,
            confirm_password: document.getElementById("confirm_password").value
        })
    })
    .then(async res => {

        if (!res.ok) {
            throw new Error("Server error");
        }

        return res.json();
    })
    .then(data => {

        btn.innerHTML = "Signup";
        btn.disabled = false;
        // if (data.success) {
        //     window.location.href = data.redirect;
        if (data.success) {

            showToast("User created successfully");

                setTimeout(()=>{
                    window.location.href = data.redirect;
                },1500);

        }
        else if (data.errors) {
            showErrors(data.errors);
        }
        else{
            showToast("User Creation failed", "error");
        }
    })
    .catch(err => {

        btn.innerHTML = "Signup";
        btn.disabled = false;

        console.error(err);
        alert("Something went wrong");
    });
}

function showErrors(errors) {

    Object.keys(errors).forEach(field => {

        let input = document.getElementById(field);
        let errorBox = document.getElementById(field + "_error");

        if (input && errorBox) {

            input.classList.add("is-invalid");
            errorBox.innerText = errors[field][0].message;
        }
    });
}
function clearErrors() {

    document.querySelectorAll(".form-control").forEach(el => {
        el.classList.remove("is-invalid");
    });

    document.querySelectorAll(".invalid-feedback").forEach(el => {
        el.innerText = "";
    });
}

function getCSRFToken(){
    return document.cookie
      .split('; ')
      .find(row => row.startsWith('csrftoken='))
      ?.split('=')[1];
}

["first_name","last_name","email","username","password","confirm_password"]
.forEach(field => {

    document.getElementById(field).addEventListener("blur", function(){
        validateSignup(field);
    });
});

// function validateSignup(activeField){

//     fetch("/validate-signup-field", {
//         method: "POST",
//         headers: {
//             "Content-Type": "application/json",
//             "X-CSRFToken": getCSRFToken()
//         },
//         body: JSON.stringify({
//             first_name: document.getElementById("first_name").value,
//             last_name: document.getElementById("last_name").value,
//             email: document.getElementById("email").value,
//             username: document.getElementById("username").value,
//             password: document.getElementById("password").value,
//             confirm_password: document.getElementById("confirm_password").value
//         })
//     })
//     .then(res => res.json())
//     .then(data => {

//         clearErrors();

//         if(data.errors){
//             showErrors(data.errors);
//         }

//     });
// }

function showFieldError(field, message){

    let input = document.getElementById(field);
    let errorBox = document.getElementById(field + "_error");

    if(input){
        input.classList.add("is-invalid");
    }

    if(errorBox){
        errorBox.innerText = message;
    }
}

function clearFieldError(field){

    let input = document.getElementById(field);
    let errorBox = document.getElementById(field + "_error");

    if(input){
        input.classList.remove("is-invalid");
    }

    if(errorBox){
        errorBox.innerText = "";
    }
}
function validateSignup(activeField){
    let payload = {
        field: activeField,  
        value: document.getElementById(activeField).value
    };
    // let payload = {
    //     first_name: document.getElementById("first_name").value,
    //     last_name: document.getElementById("last_name").value,
    //     email: document.getElementById("email").value,
    //     username: document.getElementById("username").value,
    //     password: document.getElementById("password").value,
    //     confirm_password: document.getElementById("confirm_password").value
    // };

    fetch("/validate-signup-field", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {

        clearFieldError(activeField);

        if(data.errors && data.errors[activeField]){
            showFieldError(activeField, data.errors[activeField][0].message);
        }

    });
}


$("#signupForm").on("submit", function(e){
    e.preventDefault();
    signupUser();
});


function showToast(message, type="success"){

    let toast = document.createElement("div");
    toast.className = "toast-msg toast-" + type;
    toast.innerText = message;

    document.getElementById("toastBox").appendChild(toast);

    setTimeout(()=>{
        toast.remove();
    },3000);
}

</script>

</body>
</html>